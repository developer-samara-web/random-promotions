// –ò–º–ø–æ—Ä—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
import { getUser } from "@/controllers/Users";
import { getPromotion } from "@/controllers/Promotions";
import { getParticipant, getParticipantLimit } from "@/controllers/Participant";

// –ö—Ä–º–ø–æ–Ω–µ–Ω—Ç
export async function participantMiddleware(telegram_id, promotion_id, setSuccess) {
    try {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if (!promotion_id || !telegram_id) { return { error: { message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–µ–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω.' } } };

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const user = await getUser(telegram_id);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        if (user.error) { return { error: { message: '–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.' } } };

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏
        const promotion = await getPromotion(promotion_id);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        if (promotion.error) { return { error: { message: '–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö, –∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.' } } };

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        const participant = await getParticipant(user.response._id, promotion_id);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—á–∞—Å—Ç–∏—è
        if (!participant.access) { 
            return { doubble: true, access: { message: '–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –∞–∫—Ü–∏–∏.', promotion, user } }
        };

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∞–∫—Ü–∏–∏
        if (promotion.response.status === "draft") {
            return { error: { message: '–ê–∫—Ü–∏—è –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–µ–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω.' } };
        }

        if (promotion.response.status === "completed") {
            return { error: { message: '–ê–∫—Ü–∏—è –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–µ–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω.' } };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–º–∏—É–º–∞
        if (promotion.response.requires_subscription && !user.response.subscription?.is_active) {
            return {
                error: {
                    message: '–£–ø—Å! –ö–∞–∂–µ—Ç—Å—è —É –≤–∞—Å –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ ‚≠êÔ∏è –ü—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞! \n–î–∞–Ω–Ω–∞—è –†–∞–∑–¥–∞—á–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è ‚≠êÔ∏è –ø—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –Ω–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞. ü§©–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤—Å–µ–≥–æ –∑–∞ 1 —Ä—É–±–ª—å!',
                    buttons: { name: '–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É', url: process.env.NEXT_PUBLIC_TELEGRAM_BOT_URL, icon: 'ArrowRightCircleIcon' }
                }
            };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª
        if (!user.response.channel_subscription) {
            return {
                error: {
                    message: 'üöÄ –•–æ—Ç–∏—Ç–µ –≤—ã–∏–≥—Ä–∞—Ç—å –ø—Ä–∏–∑? –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª! –¢–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö ‚Äî –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —Å–≤–æ–π —à–∞–Ω—Å!',
                    buttons: { name: '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è', url: process.env.NEXT_PUBLIC_TELEGRAM_CHANEL_URL, icon: 'ArrowRightCircleIcon' }
                }
            };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ —É—á–∞—Å—Ç–∏–π –≤ –º–µ—Å—è—Ü
        const limit = await getParticipantLimit(user.response._id)
        if (!limit.access) { return { error: { message: '–í—ã –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –ª–∏–º–∏—Ç —É—á–∞—Å—Ç–∏–π –≤ –º–µ—Å—è—Ü.' } } };

        // –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
        return { access: { status: true, promotion, user } };
    } catch (e) {
        return { error: { message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.' } };
    }
}